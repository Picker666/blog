<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>纯手写一个Promise | Picker Ready Go</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="a blog from Picker">
    
    <link rel="preload" href="/blog/assets/css/0.styles.987fb97f.css" as="style"><link rel="preload" href="/blog/assets/js/app.f85fa04d.js" as="script"><link rel="preload" href="/blog/assets/js/2.f0076038.js" as="script"><link rel="preload" href="/blog/assets/js/150.7d0bbb06.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.82be9e72.js"><link rel="prefetch" href="/blog/assets/js/100.6d575a48.js"><link rel="prefetch" href="/blog/assets/js/101.6d626c5c.js"><link rel="prefetch" href="/blog/assets/js/102.e31a2ff3.js"><link rel="prefetch" href="/blog/assets/js/103.adec8c09.js"><link rel="prefetch" href="/blog/assets/js/104.c510c25a.js"><link rel="prefetch" href="/blog/assets/js/105.4cdc2801.js"><link rel="prefetch" href="/blog/assets/js/106.9c6c0408.js"><link rel="prefetch" href="/blog/assets/js/107.4e94feaa.js"><link rel="prefetch" href="/blog/assets/js/108.56870e2c.js"><link rel="prefetch" href="/blog/assets/js/109.6110fb9e.js"><link rel="prefetch" href="/blog/assets/js/11.dc10aab3.js"><link rel="prefetch" href="/blog/assets/js/110.4284d3a0.js"><link rel="prefetch" href="/blog/assets/js/111.29709f63.js"><link rel="prefetch" href="/blog/assets/js/112.f85fc474.js"><link rel="prefetch" href="/blog/assets/js/113.8bd81730.js"><link rel="prefetch" href="/blog/assets/js/114.4298ca25.js"><link rel="prefetch" href="/blog/assets/js/115.8690d0f6.js"><link rel="prefetch" href="/blog/assets/js/116.ec48b7ef.js"><link rel="prefetch" href="/blog/assets/js/117.5b469938.js"><link rel="prefetch" href="/blog/assets/js/118.092e6e7e.js"><link rel="prefetch" href="/blog/assets/js/119.3e29b5f5.js"><link rel="prefetch" href="/blog/assets/js/12.5967ea63.js"><link rel="prefetch" href="/blog/assets/js/120.174dc57d.js"><link rel="prefetch" href="/blog/assets/js/121.357ab588.js"><link rel="prefetch" href="/blog/assets/js/122.3f63a646.js"><link rel="prefetch" href="/blog/assets/js/123.442dca3d.js"><link rel="prefetch" href="/blog/assets/js/124.135e5883.js"><link rel="prefetch" href="/blog/assets/js/125.d67689ab.js"><link rel="prefetch" href="/blog/assets/js/126.e3d11c70.js"><link rel="prefetch" href="/blog/assets/js/127.3dcfb70d.js"><link rel="prefetch" href="/blog/assets/js/128.7063b7ed.js"><link rel="prefetch" href="/blog/assets/js/129.7d761821.js"><link rel="prefetch" href="/blog/assets/js/13.043b35c7.js"><link rel="prefetch" href="/blog/assets/js/130.b8a94367.js"><link rel="prefetch" href="/blog/assets/js/131.a276a2fd.js"><link rel="prefetch" href="/blog/assets/js/132.bb9c96e7.js"><link rel="prefetch" href="/blog/assets/js/133.e8a1b333.js"><link rel="prefetch" href="/blog/assets/js/134.fd2876be.js"><link rel="prefetch" href="/blog/assets/js/135.f72a64b2.js"><link rel="prefetch" href="/blog/assets/js/136.f11435f4.js"><link rel="prefetch" href="/blog/assets/js/137.e80f09bf.js"><link rel="prefetch" href="/blog/assets/js/138.a4149630.js"><link rel="prefetch" href="/blog/assets/js/139.bc8e18a8.js"><link rel="prefetch" href="/blog/assets/js/14.1ed76eb8.js"><link rel="prefetch" href="/blog/assets/js/140.ed050d2c.js"><link rel="prefetch" href="/blog/assets/js/141.8f6bb642.js"><link rel="prefetch" href="/blog/assets/js/142.d02add4c.js"><link rel="prefetch" href="/blog/assets/js/143.2cbf77dd.js"><link rel="prefetch" href="/blog/assets/js/144.ba512194.js"><link rel="prefetch" href="/blog/assets/js/145.498efd85.js"><link rel="prefetch" href="/blog/assets/js/146.6baf0260.js"><link rel="prefetch" href="/blog/assets/js/147.a82fce34.js"><link rel="prefetch" href="/blog/assets/js/148.2bd3286f.js"><link rel="prefetch" href="/blog/assets/js/149.5a38d88b.js"><link rel="prefetch" href="/blog/assets/js/15.cb4c3eb5.js"><link rel="prefetch" href="/blog/assets/js/151.6032d781.js"><link rel="prefetch" href="/blog/assets/js/152.33f5afc6.js"><link rel="prefetch" href="/blog/assets/js/153.10dfc6f1.js"><link rel="prefetch" href="/blog/assets/js/154.fc7210f6.js"><link rel="prefetch" href="/blog/assets/js/155.cb031be0.js"><link rel="prefetch" href="/blog/assets/js/156.bba4c3f3.js"><link rel="prefetch" href="/blog/assets/js/157.c7d3c97d.js"><link rel="prefetch" href="/blog/assets/js/158.c99f2280.js"><link rel="prefetch" href="/blog/assets/js/159.81186bac.js"><link rel="prefetch" href="/blog/assets/js/16.d85fac24.js"><link rel="prefetch" href="/blog/assets/js/160.6ee2168c.js"><link rel="prefetch" href="/blog/assets/js/161.e2b5a1a7.js"><link rel="prefetch" href="/blog/assets/js/162.faac3e8f.js"><link rel="prefetch" href="/blog/assets/js/163.6269f943.js"><link rel="prefetch" href="/blog/assets/js/164.34aaae0e.js"><link rel="prefetch" href="/blog/assets/js/165.2f7e5762.js"><link rel="prefetch" href="/blog/assets/js/166.da2b367f.js"><link rel="prefetch" href="/blog/assets/js/167.ddacce4c.js"><link rel="prefetch" href="/blog/assets/js/168.ecf4ccbc.js"><link rel="prefetch" href="/blog/assets/js/169.ed063fae.js"><link rel="prefetch" href="/blog/assets/js/17.2a040317.js"><link rel="prefetch" href="/blog/assets/js/170.fa485554.js"><link rel="prefetch" href="/blog/assets/js/171.8d933c81.js"><link rel="prefetch" href="/blog/assets/js/172.9752e1fa.js"><link rel="prefetch" href="/blog/assets/js/173.e58c5e4a.js"><link rel="prefetch" href="/blog/assets/js/174.052222aa.js"><link rel="prefetch" href="/blog/assets/js/175.9eb55c7f.js"><link rel="prefetch" href="/blog/assets/js/176.fa8ee31a.js"><link rel="prefetch" href="/blog/assets/js/177.15d2cfe5.js"><link rel="prefetch" href="/blog/assets/js/178.fcbe3147.js"><link rel="prefetch" href="/blog/assets/js/179.1e9228ea.js"><link rel="prefetch" href="/blog/assets/js/18.53f1dd20.js"><link rel="prefetch" href="/blog/assets/js/180.49a617bc.js"><link rel="prefetch" href="/blog/assets/js/181.a49a0a94.js"><link rel="prefetch" href="/blog/assets/js/182.fa85b555.js"><link rel="prefetch" href="/blog/assets/js/183.e93870ee.js"><link rel="prefetch" href="/blog/assets/js/184.a3703e64.js"><link rel="prefetch" href="/blog/assets/js/185.523bd523.js"><link rel="prefetch" href="/blog/assets/js/186.8c4ad9da.js"><link rel="prefetch" href="/blog/assets/js/187.842ef238.js"><link rel="prefetch" href="/blog/assets/js/188.35835419.js"><link rel="prefetch" href="/blog/assets/js/189.f3092d4c.js"><link rel="prefetch" href="/blog/assets/js/19.e66c533f.js"><link rel="prefetch" href="/blog/assets/js/190.5572f63f.js"><link rel="prefetch" href="/blog/assets/js/191.8cbac600.js"><link rel="prefetch" href="/blog/assets/js/192.ae918cfa.js"><link rel="prefetch" href="/blog/assets/js/193.47e18c59.js"><link rel="prefetch" href="/blog/assets/js/194.8df4e8f3.js"><link rel="prefetch" href="/blog/assets/js/195.a0c3db60.js"><link rel="prefetch" href="/blog/assets/js/196.346b4813.js"><link rel="prefetch" href="/blog/assets/js/197.eae3be27.js"><link rel="prefetch" href="/blog/assets/js/198.3a3bb30d.js"><link rel="prefetch" href="/blog/assets/js/199.18dab07d.js"><link rel="prefetch" href="/blog/assets/js/20.b5d2d86f.js"><link rel="prefetch" href="/blog/assets/js/200.2efbb3da.js"><link rel="prefetch" href="/blog/assets/js/201.c226ab12.js"><link rel="prefetch" href="/blog/assets/js/202.e8afb4da.js"><link rel="prefetch" href="/blog/assets/js/203.e1ad0898.js"><link rel="prefetch" href="/blog/assets/js/204.75e7c7c4.js"><link rel="prefetch" href="/blog/assets/js/205.6bb96f91.js"><link rel="prefetch" href="/blog/assets/js/206.8605849d.js"><link rel="prefetch" href="/blog/assets/js/207.34fde133.js"><link rel="prefetch" href="/blog/assets/js/208.b3d781f4.js"><link rel="prefetch" href="/blog/assets/js/209.36354b88.js"><link rel="prefetch" href="/blog/assets/js/21.ee8eda38.js"><link rel="prefetch" href="/blog/assets/js/210.65eee9e4.js"><link rel="prefetch" href="/blog/assets/js/211.8cdc8fef.js"><link rel="prefetch" href="/blog/assets/js/212.89c8fb5b.js"><link rel="prefetch" href="/blog/assets/js/213.1b94507d.js"><link rel="prefetch" href="/blog/assets/js/214.80219b42.js"><link rel="prefetch" href="/blog/assets/js/215.7bd3ecf1.js"><link rel="prefetch" href="/blog/assets/js/216.551c7ef1.js"><link rel="prefetch" href="/blog/assets/js/217.f841af5b.js"><link rel="prefetch" href="/blog/assets/js/218.f167f706.js"><link rel="prefetch" href="/blog/assets/js/219.58aa5008.js"><link rel="prefetch" href="/blog/assets/js/22.07e359bc.js"><link rel="prefetch" href="/blog/assets/js/220.e4cc52c7.js"><link rel="prefetch" href="/blog/assets/js/221.a29ddd7d.js"><link rel="prefetch" href="/blog/assets/js/222.4c6e09e2.js"><link rel="prefetch" href="/blog/assets/js/223.30923fc8.js"><link rel="prefetch" href="/blog/assets/js/224.e3bed14a.js"><link rel="prefetch" href="/blog/assets/js/225.ad00fc8d.js"><link rel="prefetch" href="/blog/assets/js/226.b43ce0c5.js"><link rel="prefetch" href="/blog/assets/js/227.1172216e.js"><link rel="prefetch" href="/blog/assets/js/228.8cc198cb.js"><link rel="prefetch" href="/blog/assets/js/229.eba2b3d5.js"><link rel="prefetch" href="/blog/assets/js/23.7d194f57.js"><link rel="prefetch" href="/blog/assets/js/230.915297e3.js"><link rel="prefetch" href="/blog/assets/js/231.0d1cb278.js"><link rel="prefetch" href="/blog/assets/js/232.b309ad62.js"><link rel="prefetch" href="/blog/assets/js/233.3c4059f9.js"><link rel="prefetch" href="/blog/assets/js/234.72acad22.js"><link rel="prefetch" href="/blog/assets/js/235.f16fb446.js"><link rel="prefetch" href="/blog/assets/js/236.0935066b.js"><link rel="prefetch" href="/blog/assets/js/237.e61686b8.js"><link rel="prefetch" href="/blog/assets/js/238.a8c30253.js"><link rel="prefetch" href="/blog/assets/js/239.8e4e660e.js"><link rel="prefetch" href="/blog/assets/js/24.29a10bde.js"><link rel="prefetch" href="/blog/assets/js/240.d89df6c5.js"><link rel="prefetch" href="/blog/assets/js/241.82d0124e.js"><link rel="prefetch" href="/blog/assets/js/242.a5e19beb.js"><link rel="prefetch" href="/blog/assets/js/243.08ca6bfe.js"><link rel="prefetch" href="/blog/assets/js/244.f77eb000.js"><link rel="prefetch" href="/blog/assets/js/245.f6767232.js"><link rel="prefetch" href="/blog/assets/js/246.7dbad5aa.js"><link rel="prefetch" href="/blog/assets/js/247.d42d0f38.js"><link rel="prefetch" href="/blog/assets/js/248.a9553488.js"><link rel="prefetch" href="/blog/assets/js/249.871ac3bb.js"><link rel="prefetch" href="/blog/assets/js/25.f4d86629.js"><link rel="prefetch" href="/blog/assets/js/250.213d5b8c.js"><link rel="prefetch" href="/blog/assets/js/251.aa00c370.js"><link rel="prefetch" href="/blog/assets/js/252.f0f8c0df.js"><link rel="prefetch" href="/blog/assets/js/253.9eebdaaa.js"><link rel="prefetch" href="/blog/assets/js/254.c9659b32.js"><link rel="prefetch" href="/blog/assets/js/255.13675b78.js"><link rel="prefetch" href="/blog/assets/js/256.72bc3495.js"><link rel="prefetch" href="/blog/assets/js/257.8d42e26e.js"><link rel="prefetch" href="/blog/assets/js/258.25dcf3bd.js"><link rel="prefetch" href="/blog/assets/js/259.8859a04d.js"><link rel="prefetch" href="/blog/assets/js/26.983196b4.js"><link rel="prefetch" href="/blog/assets/js/260.409b7afe.js"><link rel="prefetch" href="/blog/assets/js/261.62df623b.js"><link rel="prefetch" href="/blog/assets/js/262.ef30bc71.js"><link rel="prefetch" href="/blog/assets/js/263.8552be5c.js"><link rel="prefetch" href="/blog/assets/js/264.08cbc09f.js"><link rel="prefetch" href="/blog/assets/js/265.619a52e1.js"><link rel="prefetch" href="/blog/assets/js/266.12c6ba32.js"><link rel="prefetch" href="/blog/assets/js/267.0b0686e8.js"><link rel="prefetch" href="/blog/assets/js/268.b2ef343d.js"><link rel="prefetch" href="/blog/assets/js/269.14517961.js"><link rel="prefetch" href="/blog/assets/js/27.3e06761f.js"><link rel="prefetch" href="/blog/assets/js/270.aa859c6e.js"><link rel="prefetch" href="/blog/assets/js/271.deff6ff5.js"><link rel="prefetch" href="/blog/assets/js/272.a4aed89a.js"><link rel="prefetch" href="/blog/assets/js/273.01786587.js"><link rel="prefetch" href="/blog/assets/js/274.644b9b59.js"><link rel="prefetch" href="/blog/assets/js/275.0746740f.js"><link rel="prefetch" href="/blog/assets/js/276.841f5251.js"><link rel="prefetch" href="/blog/assets/js/277.bdad1180.js"><link rel="prefetch" href="/blog/assets/js/278.fd334586.js"><link rel="prefetch" href="/blog/assets/js/279.4c49e899.js"><link rel="prefetch" href="/blog/assets/js/28.61f7021f.js"><link rel="prefetch" href="/blog/assets/js/280.62a5ef6d.js"><link rel="prefetch" href="/blog/assets/js/29.6ae0e407.js"><link rel="prefetch" href="/blog/assets/js/3.83526c41.js"><link rel="prefetch" href="/blog/assets/js/30.4bae2b1c.js"><link rel="prefetch" href="/blog/assets/js/31.f737de6c.js"><link rel="prefetch" href="/blog/assets/js/32.fa62c04e.js"><link rel="prefetch" href="/blog/assets/js/33.8d8c0f51.js"><link rel="prefetch" href="/blog/assets/js/34.4b785358.js"><link rel="prefetch" href="/blog/assets/js/35.7328d149.js"><link rel="prefetch" href="/blog/assets/js/36.4c570bf6.js"><link rel="prefetch" href="/blog/assets/js/37.b49dc1cd.js"><link rel="prefetch" href="/blog/assets/js/38.bcd848c1.js"><link rel="prefetch" href="/blog/assets/js/39.eb39e7e5.js"><link rel="prefetch" href="/blog/assets/js/4.64999949.js"><link rel="prefetch" href="/blog/assets/js/40.fc21fec3.js"><link rel="prefetch" href="/blog/assets/js/41.b8ca3df2.js"><link rel="prefetch" href="/blog/assets/js/42.99fab201.js"><link rel="prefetch" href="/blog/assets/js/43.e7611b4e.js"><link rel="prefetch" href="/blog/assets/js/44.91cd6c7b.js"><link rel="prefetch" href="/blog/assets/js/45.44fc1054.js"><link rel="prefetch" href="/blog/assets/js/46.89594e38.js"><link rel="prefetch" href="/blog/assets/js/47.8a284161.js"><link rel="prefetch" href="/blog/assets/js/48.a711196a.js"><link rel="prefetch" href="/blog/assets/js/49.656ae110.js"><link rel="prefetch" href="/blog/assets/js/5.0232ae31.js"><link rel="prefetch" href="/blog/assets/js/50.9165f52c.js"><link rel="prefetch" href="/blog/assets/js/51.898d639b.js"><link rel="prefetch" href="/blog/assets/js/52.e75364c9.js"><link rel="prefetch" href="/blog/assets/js/53.d951cbb9.js"><link rel="prefetch" href="/blog/assets/js/54.53e932f7.js"><link rel="prefetch" href="/blog/assets/js/55.e77532ef.js"><link rel="prefetch" href="/blog/assets/js/56.ee719e45.js"><link rel="prefetch" href="/blog/assets/js/57.c7a69980.js"><link rel="prefetch" href="/blog/assets/js/58.6c0eb814.js"><link rel="prefetch" href="/blog/assets/js/59.9f2dd6fb.js"><link rel="prefetch" href="/blog/assets/js/6.11998f80.js"><link rel="prefetch" href="/blog/assets/js/60.10587d85.js"><link rel="prefetch" href="/blog/assets/js/61.7ff62c9c.js"><link rel="prefetch" href="/blog/assets/js/62.34ed2ea1.js"><link rel="prefetch" href="/blog/assets/js/63.8737ffcb.js"><link rel="prefetch" href="/blog/assets/js/64.71655609.js"><link rel="prefetch" href="/blog/assets/js/65.1e228671.js"><link rel="prefetch" href="/blog/assets/js/66.4c968d00.js"><link rel="prefetch" href="/blog/assets/js/67.56f69666.js"><link rel="prefetch" href="/blog/assets/js/68.5d729b9d.js"><link rel="prefetch" href="/blog/assets/js/69.ceac6cc8.js"><link rel="prefetch" href="/blog/assets/js/7.15ccf2ce.js"><link rel="prefetch" href="/blog/assets/js/70.a92d3297.js"><link rel="prefetch" href="/blog/assets/js/71.b4d1f1fe.js"><link rel="prefetch" href="/blog/assets/js/72.ee4085a1.js"><link rel="prefetch" href="/blog/assets/js/73.1ca7fd70.js"><link rel="prefetch" href="/blog/assets/js/74.027e0008.js"><link rel="prefetch" href="/blog/assets/js/75.d15de65b.js"><link rel="prefetch" href="/blog/assets/js/76.90bb82f3.js"><link rel="prefetch" href="/blog/assets/js/77.12ba57f4.js"><link rel="prefetch" href="/blog/assets/js/78.084e854e.js"><link rel="prefetch" href="/blog/assets/js/79.453e00b9.js"><link rel="prefetch" href="/blog/assets/js/8.27f8cdef.js"><link rel="prefetch" href="/blog/assets/js/80.189b5297.js"><link rel="prefetch" href="/blog/assets/js/81.7c17819b.js"><link rel="prefetch" href="/blog/assets/js/82.2028ce60.js"><link rel="prefetch" href="/blog/assets/js/83.8b72fa33.js"><link rel="prefetch" href="/blog/assets/js/84.7acb5e45.js"><link rel="prefetch" href="/blog/assets/js/85.1c068edc.js"><link rel="prefetch" href="/blog/assets/js/86.d69a22a3.js"><link rel="prefetch" href="/blog/assets/js/87.8cbe177b.js"><link rel="prefetch" href="/blog/assets/js/88.f9f61bce.js"><link rel="prefetch" href="/blog/assets/js/89.a5f93543.js"><link rel="prefetch" href="/blog/assets/js/9.d274ae33.js"><link rel="prefetch" href="/blog/assets/js/90.9c7c7300.js"><link rel="prefetch" href="/blog/assets/js/91.946af3d2.js"><link rel="prefetch" href="/blog/assets/js/92.f1f83c52.js"><link rel="prefetch" href="/blog/assets/js/93.3546d44c.js"><link rel="prefetch" href="/blog/assets/js/94.f1b47605.js"><link rel="prefetch" href="/blog/assets/js/95.fe90f79b.js"><link rel="prefetch" href="/blog/assets/js/96.6011a9ba.js"><link rel="prefetch" href="/blog/assets/js/97.a6b4fd41.js"><link rel="prefetch" href="/blog/assets/js/98.92f8d859.js"><link rel="prefetch" href="/blog/assets/js/99.6a8b435b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.987fb97f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/images/logo.png" alt="Picker Ready Go" class="logo"> <span class="site-name can-hide">Picker Ready Go</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础梳理" class="dropdown-title"><span class="title">基础梳理</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础梳理" class="mobile-dropdown-title"><span class="title">基础梳理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/base/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/javascript/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/typescript/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/security/" class="nav-link">
  安全
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/interview/" class="nav-link">
  Interview
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/performance/" class="nav-link">
  Performance
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="库&amp;框架" class="dropdown-title"><span class="title">库&amp;框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="库&amp;框架" class="mobile-dropdown-title"><span class="title">库&amp;框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/library/transverse/" class="nav-link">
  transverse
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/redux/" class="nav-link">
  Redux
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/threeJS/" class="nav-link">
  ThreeJS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端工程化" class="dropdown-title"><span class="title">前端工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端工程化" class="mobile-dropdown-title"><span class="title">前端工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/engineering/common/" class="nav-link">
  Common
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/pack/" class="nav-link">
  Pack
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/umi/" class="nav-link">
  Umi
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/qiankun/" class="nav-link">
  qiankun
</a></li></ul></div></div><div class="nav-item"><a href="/blog/sourceAnalysis/" class="nav-link">
  源码分析
</a></div><div class="nav-item"><a href="/blog/codingTear/" class="nav-link router-link-active">
  Coding Tear
</a></div><div class="nav-item"><a href="/blog/git/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/blog/designPatterns/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端之外" class="dropdown-title"><span class="title">前端之外</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端之外" class="mobile-dropdown-title"><span class="title">前端之外</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Picker666/javaSummary" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JAVA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/outside/python/" class="nav-link">
  PYTHON
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Picker666/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础梳理" class="dropdown-title"><span class="title">基础梳理</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础梳理" class="mobile-dropdown-title"><span class="title">基础梳理</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/base/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/javascript/" class="nav-link">
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/typescript/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/security/" class="nav-link">
  安全
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/interview/" class="nav-link">
  Interview
</a></li><li class="dropdown-item"><!----> <a href="/blog/base/performance/" class="nav-link">
  Performance
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="库&amp;框架" class="dropdown-title"><span class="title">库&amp;框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="库&amp;框架" class="mobile-dropdown-title"><span class="title">库&amp;框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/library/transverse/" class="nav-link">
  transverse
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/redux/" class="nav-link">
  Redux
</a></li><li class="dropdown-item"><!----> <a href="/blog/library/threeJS/" class="nav-link">
  ThreeJS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端工程化" class="dropdown-title"><span class="title">前端工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端工程化" class="mobile-dropdown-title"><span class="title">前端工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/engineering/common/" class="nav-link">
  Common
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/pack/" class="nav-link">
  Pack
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/umi/" class="nav-link">
  Umi
</a></li><li class="dropdown-item"><!----> <a href="/blog/engineering/qiankun/" class="nav-link">
  qiankun
</a></li></ul></div></div><div class="nav-item"><a href="/blog/sourceAnalysis/" class="nav-link">
  源码分析
</a></div><div class="nav-item"><a href="/blog/codingTear/" class="nav-link router-link-active">
  Coding Tear
</a></div><div class="nav-item"><a href="/blog/git/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/blog/designPatterns/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端之外" class="dropdown-title"><span class="title">前端之外</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端之外" class="mobile-dropdown-title"><span class="title">前端之外</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Picker666/javaSummary" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JAVA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/blog/outside/python/" class="nav-link">
  PYTHON
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Picker666/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/codingTear/" aria-current="page" class="sidebar-link">call, apply and bind</a></li><li><a href="/blog/codingTear/newDeepCopy.html" class="sidebar-link">实现一个深拷贝</a></li><li><a href="/blog/codingTear/deepCopy.html" class="sidebar-link">深拷贝</a></li><li><a href="/blog/codingTear/newClass.html" class="sidebar-link">模拟实现 new 操作符</a></li><li><a href="/blog/codingTear/newPromise.html" aria-current="page" class="active sidebar-link">纯手写一个Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#一、promise-是什么" class="sidebar-link">一、Promise 是什么</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#二、promise-实现及源码解读" class="sidebar-link">二、Promise 实现及源码解读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建版本一" class="sidebar-link">Promise构建版本一</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之二-链式存储" class="sidebar-link">Promise构建之二：链式存储</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之三-状态机制、顺序执行" class="sidebar-link">Promise构建之三：状态机制、顺序执行</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之四-递归执行" class="sidebar-link">Promise构建之四：递归执行</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之五-异常处理" class="sidebar-link">Promise构建之五：异常处理</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之六-then的实现" class="sidebar-link">Promise构建之六：then的实现</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之七-catch的实现" class="sidebar-link">Promise构建之七：catch的实现</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建之八-问题补充-无缝调用" class="sidebar-link">Promise构建之八：问题补充：无缝调用</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#promise构建九-完整代码实现" class="sidebar-link">Promise构建九：完整代码实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#三、promise-race" class="sidebar-link">三、Promise.race</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#四、promise-all" class="sidebar-link">四、Promise.all</a></li><li class="sidebar-sub-header"><a href="/blog/codingTear/newPromise.html#五、promise-allsettled" class="sidebar-link">五、Promise.allSettled</a></li></ul></li><li><a href="/blog/codingTear/promise.html" class="sidebar-link">promise 手写 Base on Promise</a></li><li><a href="/blog/codingTear/debounce.html" class="sidebar-link">防抖函数debounce</a></li><li><a href="/blog/codingTear/throttle.html" class="sidebar-link">节流函数throttle</a></li><li><a href="/blog/codingTear/newBaseFunction.html" class="sidebar-link">Array 基础方法手写</a></li><li><a href="/blog/codingTear/Set.html" class="sidebar-link">实现set</a></li><li><a href="/blog/codingTear/map.html" class="sidebar-link">实现Map</a></li><li><a href="/blog/codingTear/instanceof.html" class="sidebar-link">instanceof</a></li><li><a href="/blog/codingTear/thousands.html" class="sidebar-link">添加千分符</a></li><li><a href="/blog/codingTear/loading.html" class="sidebar-link">Loading</a></li><li><a href="/blog/codingTear/loginTimeout.html" class="sidebar-link">loginTimeout</a></li><li><a href="/blog/codingTear/eventEmiter.html" class="sidebar-link">实现简单的EventEmiter</a></li><li><a href="/blog/codingTear/compose.html" class="sidebar-link">compose</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="纯手写一个promise"><a href="#纯手写一个promise" class="header-anchor">#</a> 纯手写一个<code>Promise</code></h1> <p><a href="https://github.com/Picker666/blog-example/blob/main/src/component/newFunction/Promise.jsx" target="_blank" rel="noopener noreferrer">my demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>Promise</code>就是为了解决<code>callback</code>的问题而产生的。</p> <p><code>Promise</code> 本质上就是一个绑定了回调的对象，而不是将回调传回函数内部.</p></div> <p>先看一个场景</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">getPromise1</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'XXX1'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">let</span> key <span class="token operator">=</span> data<span class="token punctuation">;</span>
               <span class="token function">resolve</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>         
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">getPromise2</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'XXX2'</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token punctuation">{</span>
                key<span class="token operator">:</span> key
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>         
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">getPromise3</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'XXX3'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>         
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>如果没有<code>Promise</code>，调用的结果又是相互依赖的，那么，会有异步嵌套的现象，结构和逻辑都会很复杂，不易读，不易维护 。</p> <p>我们把上面那个多层回调嵌套的例子用<code>Promise</code>的方式重构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getPromise1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getPromise2</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getPromise3</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'业务数据：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从改造的结果可以看出：</p> <ul><li><code>Promise</code> 在一定程度上改善了回调函数的书写方式；</li> <li>逻辑性更明显了，将异步业务提取成单个函数，整个流程可以看到是一步步向下执行的;</li> <li>依赖层级也很清晰，最后需要的数据是在整个代码的最后一步获得。</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>所以，<code>Promise</code>在一定程度上解决了回调函数的书写结构问题，但回调函数依然在主流程上存在，只不过都放到了<code>then(...)</code>里面，和我们大脑顺序线性的思维逻辑还是有出入的。</p></div> <h2 id="一、promise-是什么"><a href="#一、promise-是什么" class="header-anchor">#</a> 一、Promise 是什么</h2> <p><code>Promise</code>是什么，无论是<code>ES6</code>的<code>Promise</code>也好，<code>jQuery</code>的<code>Promise</code>也好，不同的库有不同的实现，但是大家遵循的都是同一套规范，所以，<code>Promise</code><strong>并不指特定的某个实现</strong>，<strong>它是一种规范，是一套处理JavaScript异步的机制</strong>。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>Promise</code>的规范会多，如<code>Promise/A</code>、<code>Promise/B</code>、<code>Promise/D</code>以及<code>Promise/A</code>的升级版<code>Promise/A+</code>，其中<code>ES6</code><strong>遵循</strong><code>Promise/A+</code><strong>规范</strong>。</p></div> <p>这里只简要介绍下几点与接下来内容相关的规范：</p> <ul><li><code>Promise</code> 本质是一个状态机，每个 <code>Promise</code> 有三种状态：<code>pending</code>、<code>fulfilled</code> 以及<code>rejected</code>。状态转变只能是<code>pending</code> —&gt; <code>fulfilled</code> 或者 <code>pending</code> —&gt; <code>rejected</code>。状态转变不可逆。</li> <li><code>then</code> 方法可以被同一个 <code>promise</code> 调用多次。</li> <li><code>then</code> 方法必须返回一个 <code>promise</code>。规范<strong>2.2.7</strong>中规定， <code>then</code> 必须返回一个新的 <code>Promise</code>。</li> <li>值穿透。</li></ul> <h2 id="二、promise-实现及源码解读"><a href="#二、promise-实现及源码解读" class="header-anchor">#</a> 二、Promise 实现及源码解读</h2> <p>首先，看一下Promise的简单使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do an async task async task and then...</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token comment">/* condition */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Success!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Failure!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">/* do something with the result */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* error :( */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们通过这种使用构建Promise实现的第一个版本:</p> <h3 id="promise构建版本一"><a href="#promise构建版本一" class="header-anchor">#</a> <code>Promise</code>构建版本一</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token keyword">var</span> onResolvedCallbacks  <span class="token comment">// Promise resolve回调函数</span>
    <span class="token keyword">var</span> onRejectedCallback  <span class="token comment">// Promise reject回调函数</span>
    <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onResolvedCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">// reject 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onRejectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
    <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 then 方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>大致框架已经出来了，但我们看到<code>Promise</code>状态、<code>resolve</code>函数、<code>reject</code>函数以及<code>then</code>等都没有处理。</p> <h3 id="promise构建之二-链式存储"><a href="#promise构建之二-链式存储" class="header-anchor">#</a> <code>Promise</code>构建之二：链式存储</h3> <p>先看一下使用场景</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> c<span class="token operator">=</span><span class="token number">3</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>上例结果是每间隔1s打印一个数字，顺序为1、2、3。</p> <p>这里：</p> <ul><li>让a,b,c的值能在then里面的回调接收到;</li> <li>在连续调用异步，如何确保异步函数的执行顺序。</li></ul> <p><code>Promise</code>一个常见的需求就是连续执行两个或者多个异步操作，这种情况下，每一个后来的操作都在前面的操作执行成功之后，带着上一步操作所返回的结果开始执行。这里用<code>setTimeout</code>来处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token comment">// 用于保存 then 的回调， 只有当 promise</span>
    <span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
    _this<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise resolve时的回调函数集</span>
    _this<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise reject时的回调函数集</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行</span>
            _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行</span>
            _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// reject 处理函数</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 then 方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="promise构建之三-状态机制、顺序执行"><a href="#promise构建之三-状态机制、顺序执行" class="header-anchor">#</a> <code>Promise</code>构建之三：状态机制、顺序执行</h3> <p>为了保证<code>Promise</code>的异步操作时的顺序执行，这里给<code>Promise</code>加上状态机制。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 三种状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// Promise当前的状态</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token comment">// 用于保存 then 的回调， 只有当 promise</span>
    <span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
    _this<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise resolve时的回调函数集</span>
    _this<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise reject时的回调函数集</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">FULFILLED</span> <span class="token comment">// 状态管理</span>
                _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
                _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">REJECTED</span> <span class="token comment">// 状态管理</span>
             _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
             _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// reject 处理函数</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 then 方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="promise构建之四-递归执行"><a href="#promise构建之四-递归执行" class="header-anchor">#</a> <code>Promise</code>构建之四：递归执行</h3> <p>每个<code>Promise</code>后面链接一个对象，该对象包含<code>onresolved</code>,<code>onrejected</code>,子<code>promise</code>三个属性.</p> <p>当父<code>Promise</code> 状态改变完毕,执行完相应的<code>onresolved</code>/<code>onrejected</code>的时候，拿到子<code>promise</code>,在等待这个子<code>promise</code>状态改变，在执行相应的<code>onresolved</code>/<code>onrejected</code>。依次循环直到当前<code>promise</code>没有子<code>promise</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 三种状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// Promise当前的状态</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token comment">// 用于保存 then 的回调， 只有当 promise</span>
    <span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
    _this<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise resolve时的回调函数集</span>
    _this<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise reject时的回调函数集</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果 value 是个 MyPromise， 递归执行</span>
            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">FULFILLED</span> <span class="token comment">// 状态管理</span>
                _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
                _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">REJECTED</span> <span class="token comment">// 状态管理</span>
             _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
             _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// reject 处理函数</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 then 方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="promise构建之五-异常处理"><a href="#promise构建之五-异常处理" class="header-anchor">#</a> <code>Promise</code>构建之五：异常处理</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 三种状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// Promise当前的状态</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token comment">// 用于保存 then 的回调， 只有当 promise</span>
    <span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
    _this<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise resolve时的回调函数集</span>
    _this<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise reject时的回调函数集</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果 value 是个 MyPromise， 递归执行</span>
            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">FULFILLED</span> <span class="token comment">// 状态管理</span>
                _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
                _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">REJECTED</span> <span class="token comment">// 状态管理</span>
             _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
             _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// reject 处理函数</span>
    
    <span class="token comment">// 异常处理</span>
    <span class="token comment">// new Promise(() =&gt; throw Error('error'))</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 then 方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="promise构建之六-then的实现"><a href="#promise构建之六-then的实现" class="header-anchor">#</a> <code>Promise</code>构建之六：<code>then</code>的实现</h3> <p><code>then</code> 方法是 <code>Promise</code> 的核心，这里做一下详细介绍。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一个 <code>Promise</code> 的<code>then</code>接受两个参数：<code>onFulfilled</code>和<code>onRejected</code>（都是可选参数，并且为函数，若不是函数将被忽略）</p> <ul><li><p><code>onFulfilled</code> 特性：</p> <ul><li>当 <code>Promise</code> 执行结束后其必须被调用，其第一个参数为 <code>promise</code> 的终值，也就是 <code>resolve</code> 传过来的值</li> <li>在 <code>Promise</code> 执行结束前不可被调用</li> <li>其调用次数不可超过一次</li></ul></li> <li><p><code>onRejected</code> 特性</p> <ul><li>当 <code>Promise</code> 被拒绝执行后其必须被调用，第一个参数为 <code>Promise</code> 的拒绝原因，也就是<code>reject</code>传过来的值</li> <li>在 <code>Promise</code> 执行结束前不可被调用</li> <li>其调用次数不可超过一次</li></ul></li> <li><p>调用时机
<code>onFulfilled</code> 和 <code>onRejected</code> 只有在执行环境堆栈仅包含平台代码时才可被调用（平台代码指引擎、环境以及 <code>promise</code> 的实施代码）</p></li> <li><p>调用要求
<code>onFulfilled</code> 和 <code>onRejected</code> 必须被作为函数调用（即没有 <code>this</code> 值，在 严格模式<code>strict</code> 中，函数 <code>this</code> 的值为 <code>undefined</code> ；在非严格模式中其为全局对象。）</p></li> <li><p>多次调用
<code>then</code> 方法可以被同一个 <code>promise</code> 调用多次</p> <ul><li>当 <code>promise</code> 成功执行时，所有 <code>onFulfilled</code> 需按照其注册顺序依次回调</li> <li>当 <code>promise</code> 被拒绝执行时，所有的 <code>onRejected</code> 需按照其注册顺序依次回调</li></ul></li> <li><p>返回
<code>then</code>方法会返回一个<code>Promise</code>，关于这一点，<code>Promise/A+</code>标准并没有要求返回的这个<code>Promise</code>是一个新的对象，但在<code>Promise/A</code>标准中，明确规定了<code>then</code>要返回一个新的对象，目前的<code>Promise</code>实现中<code>then</code>几乎都是返回一个新的<code>Promise</code>对象，所以在我们的实现中，也让<code>then</code>返回一个新的<code>Promise</code>对象。</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>不论 <code>promise1</code> 被 <code>reject</code> 还是被 <code>resolve</code> ， <code>promise2</code> 都会被 <code>resolve</code>，只有出现异常时才会被 <code>rejected</code>。</p></div> <p>每个<code>Promise</code>对象都可以在其上多次调用<code>then</code>方法，而每次调用<code>then</code>返回的<code>Promise</code>的状态取决于那一次调用<code>then</code>时传入参数的返回值，所以<code>then</code>不能返回<code>this</code>，因为<code>then</code>每次返回的<code>Promise</code>的结果都有可能不同。</p> <p>如果 <code>onFulfilled</code> 或者 <code>onRejected</code> 返回一个值 x ，则运行下面的 <code>Promise</code> 解决过程：[[Resolve]](promise2, x)
如果 <code>onFulfilled</code> 或者 <code>onRejected</code> 抛出一个异常 <code>e</code> ，则 <code>promise2</code> 必须拒绝执行，并返回拒因 <code>e</code>
如果 <code>onFulfilled</code> 不是函数且 <code>promise1</code> 成功执行， <code>promise2</code> 必须成功执行并返回相同的值
如果 <code>onRejected</code> 不是函数且 <code>promise1</code> 拒绝执行， <code>promise2</code> 必须拒绝执行并返回相同的拒因</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// then 方法接受两个参数，onFulfilled，onRejected，分别为Promise成功或失败的回调</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 规范 2.2.7，then 必须返回一个新的 promise</span>
    <span class="token keyword">var</span> promise2
    <span class="token comment">// 根据规范 2.2.1 ，onFulfilled、onRejected 都是可选参数</span>
    <span class="token comment">// onFulfilled、onRejected不是函数需要忽略，同时也实现了值穿透</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> error<span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>所谓的<strong>值穿透解读</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> error<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>值穿透举个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
最终打结果是<span class="token operator">**</span><span class="token number">1</span><span class="token operator">**</span>而不是<span class="token operator">**</span><span class="token number">2</span><span class="token operator">**</span>

<span class="token operator">--</span><span class="token operator">-</span>

<span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// output: alert 出 1</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>通过 <code>return this</code> 只实现了值穿透的一种情况，其实值穿透有两种情况：</p> <p><code>、</code>promise<code>已经是</code>FULFILLED/REJECTED<code>时，通过</code>return this` 实现的值穿透：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 状况A</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// output: 1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 状况B</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// output: 1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// output: true</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'anran'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// output: true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>状况A与B处 promise 已经是 FULFILLED 了符合条件，所以执行了 return this。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>注意：原生的<code>Promise</code>实现里并不是这样实现的，会打印出两个<code>false</code></p></div> <p>2、<code>promise</code> 是 <code>PENDING</code>时，通过生成新的 <code>promise</code> 加入到父 <code>promise</code> 的 <code>queue</code>，父 <code>promise</code> 有值时调用 <code>callFulfilled-&gt;doResolve</code> 或 <code>callRejected-&gt;doReject</code>（因为 <code>then</code>/<code>catch</code> 传入的参数不是函数）设置子 <code>promise</code> 的状态和值为父 <code>promise</code> 的状态与值。如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// output: 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// output: 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">===</span> b<span class="token punctuation">)</span> <span class="token comment">// output: false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>Promise</code> 有三种状态，我们分3个<code>if</code>块来处理，每块都返回一个<code>new Promise</code>。</p> <p>根据标准，我们知道，对于一下代码，<code>promise2</code>的值取决于<code>then</code>里面的返回值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果<code>promise1</code>被<code>resolve</code>了，<code>promise2</code>的被<code>1resolve</code>，如果<code>promise1</code> 被<code>reject</code>了，<code>promise2</code>将被<code>new Error('error')reject</code>。</p> <p>所以，我们需要在<code>then</code>里面执行<code>onFulfilled</code>或者<code>onRejected</code>，并根据返回着（标记中记为<code>x</code>）来确定<code>promise2</code>的结果，并且，如果<code>onFulfilled</code>/<code>onRejected</code>返回的是一个<code>Promise</code>，<code>promise</code>将直接取这个<code>Promise</code>的结果。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// then 方法接受两个参数，onFulfilled，onRejected，分别为Promise成功或失败的回调</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 规范 2.2.7，then 必须返回一个新的 promise</span>
    <span class="token keyword">var</span> promise2
    <span class="token comment">// 根据规范 2.2.1 ，onFulfilled、onRejected 都是可选参数</span>
    <span class="token comment">// onFulfilled、onRejected不是函数需要忽略，同时也实现了值穿透</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> error<span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果promise1（此处为self/this）的状态已经确定并且为fulfilled，我们调用onFulfilled</span>
        <span class="token comment">// 如果考虑到有可能throw，所以我们将其包在try/catch块中</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 规范 2.2.4，保证 onFulfilled，onRejected 异步执行</span>
          <span class="token comment">// 所以用了 setTimeout 包裹下</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
              <span class="token comment">// 如果 onFulfilled 的返回值是一个 Promise 对象，直接取它的结果作为 promise2 的结果</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 否则，以它的返回值为 promise2 的结果</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// 如果出错，以捕获到的错误作为promise2的结果</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此处实现与FULFILLED相似，区别在使用的是onRejected而不是onFulfilled</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                 <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                     x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
             <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前的Promise还处于PENDING状态，我们并不能确定调用onFulfilled还是onRejected</span>
        <span class="token comment">// 只有等待Promise的状态确定后，再做处理</span>
        <span class="token comment">// 所以我们需要把我们的两种情况的处理逻辑做成callback放入promise1（此处即self/this）的回调数组内</span>
        <span class="token comment">// 处理逻辑和以上相似</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><h3 id="promise构建之七-catch的实现"><a href="#promise构建之七-catch的实现" class="header-anchor">#</a> Promise构建之七：catch的实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// catch 的实现</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="promise构建之八-问题补充-无缝调用"><a href="#promise构建之八-问题补充-无缝调用" class="header-anchor">#</a> Promise构建之八：问题补充：无缝调用</h3> <p>不同的<code>Promise</code>实现之间需要无缝的可交互，如<code>ES6</code>的<code>Promise</code>，和我们自己实现的<code>Promise</code>之间以及其他的<code>Promise</code>实现，必须是无缝调用的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise<span class="token punctuation">.</span>reject</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token comment">// ES6 的 Promise</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token comment">// Q 的 Promise</span>
        <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 我们实现的Promise</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise<span class="token punctuation">.</span>resolve</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span> <span class="token comment">// ES6 的 Promise</span>
        <span class="token constant">Q</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span> <span class="token comment">// Q 的 Promise</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我之前实现的代码只是判断<code>OnFulfilled</code>/<code>onRejected</code>的返回值是否为我们自己实现的实例，并没有对其他类型Promise的判断，所以，上面的代码无法正常运行。</p> <p>接下来，我们解决这个问题</p> <p>关于不同<code>Promise</code>之间的交互，其实<code>Promise/A+</code>标准中有介绍，其中详细的指定了如何通过<code>then</code>的实参返回的值来决定<code>promise2</code>的状态，我们只需要按照标准把标准的内容转成代码即可。</p> <p>即我们要把<code>onFulfilled</code>/<code>onRejected</code>的返回值x。当成是一个可能是<code>Promise</code>的对象，也即标准中的<code>thenable</code>，并以最保险的姿势调用<code>x</code>上的<code>then</code>方法，如果大家都按照标准来实现，那么不同的<code>Promise</code>之间就可以交互了。</p> <p>而标准为了保险起见，即使x返回了一个带有<code>then</code>属性但不遵循<code>Promise</code>标准的对象（不如说这个<code>x</code>把它<code>then</code>里的两个参数都调用了，同步或者异步调用（<code>PS</code>，原则上<code>then</code>的两个参数需要异步调用，下文会讲到），或者是出错后又调用了它们，或者<code>then</code>根本不是一个函数），也能尽可能正确处理。</p> <p>关于为何需要不同的<code>Promise</code>实现能够相互交互，我想原因应该是显然的，<code>Promise</code>并不是<code>JS</code>一早就有的标准，不同第三方的实现之间是并不相互知晓的，如果你使用的某一个库中封装了一个<code>Promise</code>实现，想象一下如果它不能跟你自己使用的<code>Promise</code>实现交互的场景。。。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 规范 2.3</span>
<span class="token comment">/*
resolutionProcedure函数即为根据x的值来决定promise2的状态的函数
也即标准中的[Promise Resolution Procedure](https://promisesaplus.com/#point-47)
x 为 promise2 = promise1.then(onFulfilled, onRejected)里onFulfilled/onRejected的返回值
resolve 和 reject 实际上是 promise2 的executor的两个实参，因为很难挂在其他地方，所以一并传过来。
相信各位一定可以对照标准转换成代码，这里就只标出代码在标准中对应的位置，只在必要的地方做一些解释。
*/</span>
<span class="token keyword">function</span> <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 规范 2.3.1，x 不能和 promise2 相同，避免循环引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Chaining cycle detected for promise!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 规范 2.3.2</span>
    <span class="token comment">// 如果 x 为 Promise，状态为 pending 需要继续等待否则执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.3.2.1 如果x为pending状态，promise必须保持pending状态，直到x为fulfilled/rejected</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 再次调用该函数是为了确认 x resolve 的</span>
                <span class="token comment">// 参数是什么类型，如果是基本类型就再次 resolve</span>
                <span class="token comment">// 把值传给下个 then</span>
                <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 但如果这个promise的状态已经确定了，那么它肯定有一个正常的值，而不是一个thenable，所以这里可以取它的状态</span>
            x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 规范 2.3.3，判断 x 是否为对象或函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 规范 2.3.3.2，如果不能取出 then，就 reject</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 规范2.3.3.1 因为x.then可能是一个getter，这种情况下多次读取就有可能产生副作用</span>
            <span class="token comment">// 既要判断它的类型，又要调用它，这就是两次读取</span>
            <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
            <span class="token comment">// 规范2.3.3.3，如果 then 是函数，调用 x.then</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 规范 2.3.3.3</span>
       <span class="token comment">// reject 或 reject 其中一个执行过的话，忽略其他的</span>
                <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                    x<span class="token punctuation">,</span>
                    <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 规范 2.3.3.3.1</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
                        called <span class="token operator">=</span> <span class="token boolean">true</span>
                        <span class="token comment">// 规范 2.3.3.3.1</span>
                        <span class="token keyword">return</span> <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
                        called <span class="token operator">=</span> <span class="token boolean">true</span>
                         <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 规范 2.3.3.4</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 规范 2.3.3.2</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 规范 2.3.4，x 为基本类型</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

然后，我们使用<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">resolutionProcedure</span><span class="token template-punctuation string">`</span></span>函数替换<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">MyPromise.prototype.then</span><span class="token template-punctuation string">`</span></span>里面几处判断<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">x</span><span class="token template-punctuation string">`</span></span>是否为<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">MyPromise</span><span class="token template-punctuation string">`</span></span>对象的位置即可。即：

<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`js
<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// resolve(x) // 否则，以它的返回值为 promise2 的结果</span>

替换为：（总共四处，不要遗漏了）

<span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><h3 id="promise构建九-完整代码实现"><a href="#promise构建九-完整代码实现" class="header-anchor">#</a> <code>Promise</code>构建九：完整代码实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 三种状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// Promise当前的状态</span>
    _this<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token comment">// Promise的值</span>
    <span class="token comment">// 用于保存 then 的回调， 只有当 promise</span>
    <span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
    _this<span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise resolve时的回调函数集</span>
    _this<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Promise reject时的回调函数集</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果 value 是个 Promise， 递归执行</span>
            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">FULFILLED</span> <span class="token comment">// 状态管理</span>
                _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
                _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// resolve 处理函数</span>
    _this<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 异步执行，保证顺序执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _this<span class="token punctuation">.</span>currentState <span class="token operator">=</span> <span class="token constant">REJECTED</span> <span class="token comment">// 状态管理</span>
                _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value
                _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">// reject 处理函数</span>

    <span class="token comment">// 异常处理</span>
    <span class="token comment">// new Promise(() =&gt; throw Error('error'))</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> _this<span class="token punctuation">.</span>reject<span class="token punctuation">)</span> <span class="token comment">// 执行callback并传入相应的参数</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// then 方法接受两个参数，onFulfilled，onRejected，分别为Promise成功或失败的回调</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 规范 2.2.7，then 必须返回一个新的 promise</span>
    <span class="token keyword">var</span> promise2
    <span class="token comment">// 根据规范 2.2.1 ，onFulfilled、onRejected 都是可选参数</span>
    <span class="token comment">// onFulfilled、onRejected不是函数需要忽略，同时也实现了值穿透</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> error<span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果promise1（此处为self/this）的状态已经确定并且为fulfilled，我们调用onFulfilled</span>
        <span class="token comment">// 如果考虑到有可能throw，所以我们将其包在try/catch块中</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                <span class="token comment">// 如果 onFulfilled 的返回值是一个 Promise 对象，直接取它的结果作为 promise2 的结果</span>
                <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// 如果出错，以捕获到的错误作为promise2的结果</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此处实现与FULFILLED相似，区别在使用的是onRejected而不是onFulfilled</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前的Promise还处于PENDING状态，我们并不能确定调用onFulfilled还是onRejected</span>
        <span class="token comment">// 只有等待Promise的状态确定后，再做处理</span>
        <span class="token comment">// 所以我们需要把我们的两种情况的处理逻辑做成callback放入promise1（此处即_this/this）的回调数组内</span>
        <span class="token comment">// 处理逻辑和以上相似</span>
        <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _this<span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            _this<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 规范 2.3</span>
    <span class="token comment">/*
    resolutionProcedure函数即为根据x的值来决定promise2的状态的函数
    也即标准中的[Promise Resolution Procedure](https://promisesaplus.com/#point-47)
    x 为 promise2 = promise1.then(onFulfilled, onRejected)里onFulfilled/onRejected的返回值
    resolve 和 reject 实际上是 promise2 的executor的两个实参，因为很难挂在其他地方，所以一并传过来。
    相信各位一定可以对照标准转换成代码，这里就只标出代码在标准中对应的位置，只在必要的地方做一些解释。
    */</span>
    <span class="token keyword">function</span> <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 规范 2.3.1，x 不能和 promise2 相同，避免循环引用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Chaining cycle detected for promise!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 规范 2.3.2</span>
        <span class="token comment">// 如果 x 为 Promise，状态为 pending 需要继续等待否则执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.3.2.1 如果x为pending状态，promise必须保持pending状态，直到x为fulfilled/rejected</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 再次调用该函数是为了确认 x resolve 的</span>
                    <span class="token comment">// 参数是什么类型，如果是基本类型就再次 resolve</span>
                    <span class="token comment">// 把值传给下个 then</span>
                    <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 但如果这个promise的状态已经确定了，那么它肯定有一个正常的值，而不是一个thenable，所以这里可以取它的状态</span>
                x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 规范 2.3.3，判断 x 是否为对象或函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 规范 2.3.3.2，如果不能取出 then，就 reject</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 规范2.3.3.1 因为x.then可能是一个getter，这种情况下多次读取就有可能产生副作用</span>
                <span class="token comment">// 既要判断它的类型，又要调用它，这就是两次读取</span>
                <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
                <span class="token comment">// 规范2.3.3.3，如果 then 是函数，调用 x.then</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 规范 2.3.3.3</span>
                    <span class="token comment">// reject 或 reject 其中一个执行过的话，忽略其他的</span>
                    <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
                        x<span class="token punctuation">,</span>
                        <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 规范 2.3.3.3.1</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
                            called <span class="token operator">=</span> <span class="token boolean">true</span>
                            <span class="token comment">// 规范 2.3.3.3.1</span>
                            <span class="token keyword">return</span> <span class="token function">resolutionProcedure</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
                            called <span class="token operator">=</span> <span class="token boolean">true</span>
                            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 规范 2.3.3.4</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 规范 2.3.3.2</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 规范 2.3.3.3.3，即这三处谁先执行就以谁的结果为准</span>
                called <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 规范 2.3.4，x 为基本类型</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// catch 的实现</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// finally 的实现</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br></div></div><h2 id="三、promise-race"><a href="#三、promise-race" class="header-anchor">#</a> 三、<code>Promise.race</code></h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// race</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        values<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="四、promise-all"><a href="#四、promise-all" class="header-anchor">#</a> 四、<code>Promise.all</code></h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> remaining <span class="token operator">=</span> args<span class="token punctuation">.</span>length
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">function</span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span> <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">res</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>currentState <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                    val<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">res</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> then <span class="token operator">=</span> val<span class="token punctuation">.</span>then
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token function">then</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">res</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> val
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>remaining <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="五、promise-allsettled"><a href="#五、promise-allsettled" class="header-anchor">#</a> 五、<code>Promise.allSettled</code></h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">allSettled</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      promises <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token operator">?</span> promises <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> len <span class="token operator">=</span> promises<span class="token punctuation">.</span>length
      <span class="token keyword">const</span> argslen <span class="token operator">=</span> len
      <span class="token comment">// 如果传入的是一个空数组，那么就直接返回一个resolved的空数组promise对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">// 将传入的参数转化为数组，赋给args变量</span>
      <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span>
      <span class="token comment">// 计算当前是否所有的 promise 执行完成，执行完毕则resolve</span>
      <span class="token keyword">const</span> <span class="token function-variable function">compute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">--</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token function">resolve</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断传入的是否是 promise 类型</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token keyword">const</span> then <span class="token operator">=</span> value<span class="token punctuation">.</span>then
          <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            args<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> val<span class="token punctuation">}</span>
            <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            args<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'rejected'</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> e <span class="token punctuation">}</span>
            <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          args<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> value<span class="token punctuation">}</span>
          <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argslen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/codingTear/newClass.html" class="prev">
        模拟实现 new 操作符
      </a></span> <span class="next"><a href="/blog/codingTear/promise.html">
        promise 手写 Base on Promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.f85fa04d.js" defer></script><script src="/blog/assets/js/2.f0076038.js" defer></script><script src="/blog/assets/js/150.7d0bbb06.js" defer></script>
  </body>
</html>
